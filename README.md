# LZ快捷人格生成器 v2.0

> AI 驱动的人格生成、优化、用户画像工具

一个功能强大的 AstrBot 插件，让你可以通过简单的命令快速生成、优化和管理 AI 人格，还支持自动构建用户画像。

## ✨ 功能特性

### 🎭 人格管理
- **智能生成** - 输入简单描述，AI 自动生成完整人格提示词
- **引导式生成** - 分析描述缺失字段，引导用户补充或自动生成
- **智能优化** - 根据反馈智能调整现有人格
- **提示词压缩** - 支持轻度/中度/极限三档压缩
- **多格式支持** - 支持 Natural/Markdown/XML/JSON/YAML 格式互转
- **版本备份** - 自动备份历史版本，支持一键回滚
- **智能意图识别** - `/人格` 命令智能理解你的意图

### 👤 用户画像
- **持续监控** - 实时监控指定用户的聊天消息，增量更新画像
- **画像提取** - 从对话中自动提取用户特征
- **多种模式** - 支持全局/群组/私聊监控模式
- **画像卡片** - 美观的画像展示卡片
- **轻量设计** - 采用持续监控而非扫描历史记录，对服务器负载友好

> 💡 **为什么采用持续监控？**  
> 本插件采用「持续监控 + 增量更新」的方式构建用户画像，而不是扫描大量历史聊天记录。这是考虑到很多小型服务器的负载难以支撑一次性扫描大量消息的开销。如果你希望通过扫描历史聊天记录来快速生成画像，可以在 AstrBot 插件市场中搜索「**人物画像**」插件。

### 🔗 系统集成
- **原生对接** - 与 AstrBot Persona/Conversation 系统无缝集成
- **会话锁** - 防止并发操作导致的状态错乱

## 📖 命令列表

### 🤖 智能入口（推荐）

| 命令 | 说明 |
|------|------|
| `/人格 <自然语言>` | 智能识别意图，自动执行对应操作 |

**示例：**
```
/人格 生成一个傲娇猫娘        → 自动生成人格
/人格 让她更傲娇一点          → 自动优化人格
/人格 确认                    → 确认保存
/人格 切换到猫娘              → 激活人格
```

### 📝 人格管理命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/快捷人格 生成人格 <描述>` | 生成人格 | `/快捷人格 生成人格 一个温柔的猫娘` |
| `/快捷人格 优化人格 <反馈>` | 优化当前/待确认人格 | `/快捷人格 优化人格 说话再可爱一点` |
| `/快捷人格 压缩人格 [强度]` | 压缩提示词 | `/快捷人格 压缩人格 中度` |
| `/快捷人格 转换格式 <格式>` | 格式转换 | `/快捷人格 转换格式 markdown` |
| `/快捷人格 确认生成` | 保存待确认人格 | - |
| `/快捷人格 取消操作` | 取消待确认人格 | - |
| `/快捷人格 查看状态` | 查看当前状态 | - |
| `/快捷人格 人格列表` | 列出所有人格 | - |
| `/快捷人格 查看详情 [ID]` | 查看人格详情 | - |
| `/快捷人格 选择人格 <ID>` | 选择操作目标 | - |
| `/快捷人格 应用人格 [ID]` | 激活到当前对话 | - |
| `/快捷人格 新建对话 [ID]` | 新建对话并激活 | - |
| `/快捷人格 历史版本 [ID]` | 查看历史版本 | - |
| `/快捷人格 版本回滚 [ID]` | 回滚到上一版本 | - |
| `/快捷人格 删除人格 <ID>` | 删除人格 | - |

**别名支持：** `/qp` 或 `/quickpersona`

### 👤 用户画像命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/画像 帮助` | 显示画像功能帮助 | - |
| `/画像 添加监控 <用户ID> [模式]` | 添加监控 | `/画像 添加监控 12345 global` |
| `/画像 移除监控 <用户ID>` | 移除监控 | `/画像 移除监控 12345` |
| `/画像 监控列表` | 查看所有监控 | - |
| `/画像 查看 <用户ID>` | 查看用户画像 | - |
| `/画像 列表` | 查看所有画像 | - |
| `/画像 强制更新 <用户ID>` | 立即更新画像 | - |
| `/画像 删除 <用户ID>` | 删除画像 | - |

**别名支持：** `/profile` 或 `/pf`

## 🚀 快速开始

### 人格生成
```
1. /人格 生成一个毒舌但内心温柔的傲娇少女
2. /人格 确认              # 满意后保存
3. /人格 应用              # 激活到对话
```

### 用户画像
```
1. 在配置中启用 profile_enabled
2. /画像 添加监控 12345 global
3. 等待用户发送消息后自动生成画像
4. /画像 查看 12345
```

## ⚙️ 配置项

### 基础配置
| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `enabled` | 启用插件 | `true` |
| `architect_provider_id` | 架构师模型 Provider ID | 空（使用默认） |
| `architect_timeout` | 架构师超时时间(秒) | `60` |

### 人格配置
| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `max_prompt_length` | 人格提示词最大字符数 | `800` |
| `auto_compress` | 生成后自动压缩 | `true` |
| `confirm_before_apply` | 应用前需确认 | `true` |
| `backup_versions` | 历史版本保留数 | `5` |
| `enable_guided_generation` | 启用引导式生成 | `true` |
| `default_prompt_format` | 默认提示词格式 | `natural` |

### 画像配置
| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `profile_enabled` | 启用用户画像功能 | `false` |
| `profile_update_interval` | 画像更新间隔(秒) | `300` |
| `profile_message_threshold` | 触发更新的消息数 | `10` |
| `profile_max_history` | 保留的最大历史消息数 | `50` |

### 模板配置
| 配置项 | 说明 |
|--------|------|
| `persona_gen_template` | 人格生成模板 |
| `persona_refine_template` | 人格优化模板 |
| `persona_shrink_template` | 人格压缩模板 |
| `profile_update_template` | 画像更新模板 |
| `profile_init_template` | 画像初始化模板 |

## 💡 使用技巧

### 生成高质量人格
- 描述越具体，生成效果越好
- 可以包含：角色背景、性格特点、说话风格、独特之处
- 使用引导式生成（默认开启）可获得更完整的人格

### 迭代优化
- 生成后不满意？直接说反馈即可
- `/人格 让她更傲娇一点` - 优化待确认的人格
- 每次优化自动备份上一版本

### 格式选择
- **natural** - 自然语言，可读性最好
- **markdown** - 结构化，支持格式
- **xml** - 严格结构，适合解析
- **json/yaml** - 机器可读格式

### 节省 Token
- 使用 `/快捷人格 压缩人格` 压缩提示词
- 轻度：去除冗余表述
- 中度：转换为结构化格式
- 极限：极简键值对形式

## 🔧 技术架构

### 项目结构
```
astrbot_plugin_lzpersona/
├── main.py              # 插件入口
├── commands/            # 命令处理
│   ├── persona.py       # 人格管理命令
│   └── profile.py       # 用户画像命令
├── services/            # 业务服务
│   ├── llm.py           # LLM 调用封装
│   ├── persona.py       # 人格管理服务
│   ├── profile.py       # 画像管理服务
│   ├── config.py        # 配置管理
│   └── render.py        # 渲染服务
├── core/                # 核心模块
│   ├── models.py        # 数据模型
│   ├── state.py         # 状态管理
│   ├── constants.py     # 常量定义
│   └── format_templates.py  # 格式模板
└── utils/               # 工具函数
```

### 数据存储
历史版本存储在 AstrBot data 目录的 **plugin_data** 文件夹中：

```
data/plugin_data/astrbot_plugin_lzpersona/
├── backups/             # 人格备份
│   └── lz_猫娘_abc123/
│       ├── v001_20260202_123456.txt
│       └── v002_20260202_134500.txt
└── profiles/            # 用户画像
    └── 12345.json
```

### 与 AstrBot 集成
- **PersonaManager** - 人格与控制台完全互通
- **ConversationManager** - 支持为对话指定人格
- 人格 ID 以 `lz_` 前缀标识

## 📋 更新日志

详见 [CHANGELOG.md](CHANGELOG.md)

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📝 License

MIT License
